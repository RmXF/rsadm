#!/bin/bash

# ====================================================
# CEO MANAGER PRO v2.0 - INSTALADOR AUTOMÃTICO
# Author: @ReyRs_VIPro
# VersiÃ³n: 2.0
# Enlace del Panel: https://github.com/RmXF/rsadm/raw/main/panelv2.zip
# ====================================================

# Colores
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
WHITE='\033[1;37m'
NC='\033[0m'

# ConfiguraciÃ³n
INSTALL_DIR="/var/www/ceo-manager"
NGINX_CONF="/etc/nginx/sites-available/ceo-manager"
LOG_FILE="/var/log/ceo-install.log"
STATUS_FILE="/tmp/ceo-status.json"
ZIP_URL="https://github.com/RmXF/rsadm/raw/main/panel2.2.zip"

# Variables
PANEL_USER=""
PANEL_PASS=""
PANEL_PASS_CLEAR=""
PANEL_PORT=""
PANEL_HASH=""
IP_ADDRESS=""

# Array para status de instalaciÃ³n
declare -A INSTALL_STATUS

# ====================================================
# FUNCIONES DE UTILIDAD
# ====================================================

print_banner() {
    clear
    echo -e "${PURPLE}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘                                                              â•‘"
    echo "â•‘              CEO MANAGER PRO v2.0 - INSTALADOR              â•‘"
    echo "â•‘                                                              â•‘"
    echo "â•‘                  Desarrollado por @ReyRs_VIPro              â•‘"
    echo "â•‘                                                              â•‘"
    echo "â•‘              GitHub: https://github.com/RmXF/rsadm          â•‘"
    echo "â•‘                                                              â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
    echo ""
}

print_message() {
    echo -e "${BLUE}[CEO]${NC} $1"
}

print_success() {
    echo -e "${GREEN}[âœ“]${NC} $1"
}

print_error() {
    echo -e "${RED}[âœ—]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[!]${NC} $1"
}

print_status() {
    local component=$1
    local status=$2
    local message=$3
    
    if [[ "$status" == "ok" ]]; then
        echo -e "  ${GREEN}âœ“${NC} $component: ${GREEN}$message${NC}"
        INSTALL_STATUS["$component"]="OK"
    elif [[ "$status" == "warning" ]]; then
        echo -e "  ${YELLOW}âš ${NC} $component: ${YELLOW}$message${NC}"
        INSTALL_STATUS["$component"]="WARNING"
    else
        echo -e "  ${RED}âœ—${NC} $component: ${RED}$message${NC}"
        INSTALL_STATUS["$component"]="FAILED"
    fi
}

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a $LOG_FILE
}

check_root() {
    if [[ $EUID -ne 0 ]]; then
        print_error "Este script debe ejecutarse como root"
        echo -e "${YELLOW}Ejecuta: sudo bash $0${NC}"
        exit 1
    fi
    print_status "Root" "ok" "Ejecutando como root"
}

get_ip() {
    IP_ADDRESS=$(curl -s ifconfig.me 2>/dev/null || curl -s icanhazip.com 2>/dev/null || hostname -I | awk '{print $1}')
    if [[ -z "$IP_ADDRESS" ]]; then
        IP_ADDRESS="IP_NO_DETECTADA"
        print_status "IP" "warning" "No se pudo detectar automÃ¡ticamente"
    else
        print_status "IP" "ok" "$IP_ADDRESS"
    fi
}

# ====================================================
# VERIFICACIÃ“N DEL SISTEMA
# ====================================================

check_system() {
    print_message "Verificando sistema..."
    
    # Detectar SO
    if [[ -f /etc/os-release ]]; then
        . /etc/os-release
        OS=$ID
        OS_NAME=$NAME
        OS_VERSION=$VERSION
        print_status "Sistema" "ok" "$OS_NAME $OS_VERSION"
    else
        print_status "Sistema" "warning" "No detectado"
    fi
    
    # Verificar arquitectura
    ARCH=$(uname -m)
    print_status "Arquitectura" "ok" "$ARCH"
    
    # Verificar espacio en disco
    AVAILABLE=$(df / | awk 'NR==2 {print $4}')
    AVAILABLE_MB=$((AVAILABLE / 1024))
    AVAILABLE_GB=$((AVAILABLE_MB / 1024))
    
    if [[ $AVAILABLE_MB -lt 500 ]]; then
        print_status "Espacio" "failed" "${AVAILABLE_MB}MB (mÃ­nimo 500MB)"
        log "ERROR: Espacio insuficiente"
    else
        if [[ $AVAILABLE_GB -gt 0 ]]; then
            print_status "Espacio" "ok" "${AVAILABLE_GB}GB disponibles"
        else
            print_status "Espacio" "ok" "${AVAILABLE_MB}MB disponibles"
        fi
    fi
    
    # Verificar memoria RAM
    TOTAL_RAM=$(free -m | awk 'NR==2 {print $2}')
    if [[ $TOTAL_RAM -lt 256 ]]; then
        print_status "RAM" "warning" "${TOTAL_RAM}MB (mÃ­nimo recomendado 256MB)"
    else
        print_status "RAM" "ok" "${TOTAL_RAM}MB"
    fi
    
    echo ""
}

# ====================================================
# CONFIGURACIÃ“N DEL PANEL
# ====================================================

get_config() {
    echo ""
    print_warning "CONFIGURACIÃ“N DEL PANEL"
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    
    # Usuario
    while true; do
        read -p "ðŸ‘¤ Usuario administrador: " PANEL_USER
        if [[ -z "$PANEL_USER" ]]; then
            print_error "El usuario no puede estar vacÃ­o"
        elif [[ ! "$PANEL_USER" =~ ^[a-zA-Z0-9_]+$ ]]; then
            print_error "Solo letras, nÃºmeros y guiÃ³n bajo"
        else
            break
        fi
    done
    
    # ContraseÃ±a (guardar versiÃ³n clara para mostrarla despuÃ©s)
    while true; do
        echo -n "ðŸ”‘ ContraseÃ±a: "
        read -s PANEL_PASS
        echo ""
        echo -n "ðŸ”’ Confirmar: "
        read -s PANEL_PASS_CONFIRM
        echo ""
        
        if [[ -z "$PANEL_PASS" ]]; then
            print_error "La contraseÃ±a no puede estar vacÃ­a"
        elif [[ "$PANEL_PASS" != "$PANEL_PASS_CONFIRM" ]]; then
            print_error "Las contraseÃ±as no coinciden"
        elif [[ ${#PANEL_PASS} -lt 4 ]]; then
            print_error "MÃ­nimo 4 caracteres"
        else
            PANEL_PASS_CLEAR="$PANEL_PASS"
            break
        fi
    done
    
    # Puerto
    read -p "ðŸ”Œ Puerto (default: 8080): " PANEL_PORT_INPUT
    PANEL_PORT=${PANEL_PORT_INPUT:-8080}
    
    if ! [[ "$PANEL_PORT" =~ ^[0-9]+$ ]] || [[ "$PANEL_PORT" -lt 1 ]] || [[ "$PANEL_PORT" -gt 65535 ]]; then
        print_error "Puerto invÃ¡lido, usando 8080"
        PANEL_PORT=8080
    fi
    
    # Verificar puerto disponible
    if ss -tlnp | grep -q ":$PANEL_PORT "; then
        print_warning "Puerto $PANEL_PORT en uso por otro servicio"
        read -p "Â¿Usar otro puerto? (s/n): " CHANGE_PORT
        if [[ "$CHANGE_PORT" =~ ^[Ss]$ ]]; then
            get_config
            return
        fi
    fi
    
    # Generar hash de contraseÃ±a
    PANEL_HASH=$(php -r "echo password_hash('$PANEL_PASS', PASSWORD_DEFAULT);" 2>/dev/null)
    
    # Resumen
    echo ""
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${YELLOW}RESUMEN DE CONFIGURACIÃ“N:${NC}"
    echo "  ðŸ‘¤ Usuario: $PANEL_USER"
    echo "  ðŸ”‘ ContraseÃ±a: $PANEL_PASS_CLEAR"
    echo "  ðŸ”Œ Puerto: $PANEL_PORT"
    echo "  ðŸ“ Directorio: $INSTALL_DIR"
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    
    read -p "Â¿Continuar con la instalaciÃ³n? (s/n): " CONFIRM
    if [[ ! "$CONFIRM" =~ ^[Ss]$ ]]; then
        print_error "InstalaciÃ³n cancelada"
        exit 0
    fi
}

# ====================================================
# INSTALACIÃ“N DE DEPENDENCIAS
# ====================================================

install_dependencies() {
    print_message "Instalando dependencias..."
    log "Iniciando instalaciÃ³n de dependencias"
    
    # Actualizar repositorios
    apt-get update -y >> $LOG_FILE 2>&1
    if [[ $? -eq 0 ]]; then
        print_status "Repositorios" "ok" "Actualizados"
    else
        print_status "Repositorios" "warning" "Error al actualizar"
    fi
    
    # Instalar Nginx
    apt-get install -y nginx >> $LOG_FILE 2>&1
    if command -v nginx &> /dev/null; then
        print_status "Nginx" "ok" "$(nginx -v 2>&1 | cut -d'/' -f2)"
    else
        print_status "Nginx" "failed" "No se instalÃ³"
    fi
    
    # Instalar PHP
    apt-get install -y php8.1 php8.1-fpm php8.1-cli php8.1-common \
        php8.1-mbstring php8.1-xml php8.1-curl php8.1-zip php8.1-gd >> $LOG_FILE 2>&1
    
    if command -v php8.1 &> /dev/null; then
        PHP_VERSION=$(php8.1 -v | head -1 | cut -d' ' -f2)
        print_status "PHP" "ok" "$PHP_VERSION"
    elif command -v php &> /dev/null; then
        PHP_VERSION=$(php -v | head -1 | cut -d' ' -f2)
        print_status "PHP" "ok" "$PHP_VERSION (versiÃ³n alternativa)"
    else
        print_status "PHP" "failed" "No se instalÃ³"
    fi
    
    # Instalar herramientas
    local tools=("curl" "wget" "unzip" "sshpass" "ufw" "net-tools")
    for tool in "${tools[@]}"; do
        apt-get install -y $tool >> $LOG_FILE 2>&1
        if command -v $tool &> /dev/null; then
            print_status "$tool" "ok" "Instalado"
        else
            print_status "$tool" "warning" "No se pudo instalar"
        fi
    done
    
    echo ""
}

# ====================================================
# DESCARGA DEL PANEL
# ====================================================

download_panel() {
    print_message "Descargando panel desde GitHub..."
    log "URL: $ZIP_URL"
    
    cd /tmp
    rm -rf ceo-install 2>/dev/null
    mkdir -p ceo-install
    cd ceo-install
    
    # Intentar con wget
    if command -v wget &> /dev/null; then
        wget -O panel.zip $ZIP_URL >> $LOG_FILE 2>&1
        if [[ $? -eq 0 ]] && [[ -f "panel.zip" ]] && [[ -s "panel.zip" ]]; then
            print_status "Descarga" "ok" "wget"
        else
            print_status "Descarga" "warning" "wget fallÃ³, intentando con curl"
            # Intentar con curl
            curl -L -o panel.zip $ZIP_URL >> $LOG_FILE 2>&1
        fi
    elif command -v curl &> /dev/null; then
        curl -L -o panel.zip $ZIP_URL >> $LOG_FILE 2>&1
    fi
    
    # Verificar descarga
    if [[ ! -f "panel.zip" ]] || [[ ! -s "panel.zip" ]]; then
        print_status "Descarga" "failed" "No se pudo descargar el panel"
        log "ERROR: FallÃ³ la descarga del panel"
        return 1
    fi
    
    # Mostrar tamaÃ±o
    ZIP_SIZE=$(du -h panel.zip | cut -f1)
    print_status "ZIP" "ok" "$ZIP_SIZE"
    
    # Descomprimir
    unzip -o panel.zip >> $LOG_FILE 2>&1
    if [[ $? -eq 0 ]]; then
        print_status "DescompresiÃ³n" "ok" "Archivos extraÃ­dos"
    else
        print_status "DescompresiÃ³n" "failed" "Error al descomprimir"
        return 1
    fi
    
    # Listar archivos
    FILE_COUNT=$(find . -type f | wc -l)
    print_status "Archivos" "ok" "$FILE_COUNT archivos extraÃ­dos"
    
    echo ""
    return 0
}

# ====================================================
# CONFIGURACIÃ“N DEL PANEL
# ====================================================

configure_panel() {
    print_message "Configurando panel..."
    
    # Crear directorio de instalaciÃ³n
    mkdir -p $INSTALL_DIR
    if [[ -d "$INSTALL_DIR" ]]; then
        print_status "Directorio" "ok" "$INSTALL_DIR"
    else
        print_status "Directorio" "failed" "No se pudo crear"
    fi
    
    # Copiar archivos
    cd /tmp/ceo-install
    
    # Detectar estructura del ZIP
    if [[ -d "ceo-manager" ]]; then
        cp -rf ceo-manager/* $INSTALL_DIR/ 2>/dev/null
        print_status "Estructura" "ok" "ceo-manager"
    elif [[ -d "panelv2" ]]; then
        cp -rf panelv2/* $INSTALL_DIR/ 2>/dev/null
        print_status "Estructura" "ok" "panelv2"
    else
        cp -rf * $INSTALL_DIR/ 2>/dev/null
        print_status "Estructura" "ok" "raÃ­z del ZIP"
    fi
    
    # Crear directorios necesarios
    mkdir -p $INSTALL_DIR/{assets/{css,js},includes,php/endpoints,logs}
    
    # Configurar credenciales
    local config_file="$INSTALL_DIR/includes/config.php"
    
    if [[ -f "$config_file" ]]; then
        # Backup del original
        cp "$config_file" "$config_file.bak"
        
        # Reemplazar credenciales si existen
        sed -i "s/define('CEO_USER', '.*');/define('CEO_USER', '$PANEL_USER');/" "$config_file"
        sed -i "s|define('CEO_PASS', '.*');|define('CEO_PASS', '$PANEL_HASH');|" "$config_file"
        
        # Si no encuentra las lÃ­neas, agregarlas al final
        if ! grep -q "CEO_USER" "$config_file"; then
            echo "define('CEO_USER', '$PANEL_USER');" >> "$config_file"
        fi
        if ! grep -q "CEO_PASS" "$config_file"; then
            echo "define('CEO_PASS', '$PANEL_HASH');" >> "$config_file"
        fi
        
        print_status "Config.php" "ok" "Credenciales actualizadas"
    else
        # Crear config.php desde cero
        cat > "$config_file" << EOF
<?php
/**
 * CEO MANAGER PRO - ConfiguraciÃ³n
 * Author: @ReyRs_VIPro
 */

define('CEO_VERSION', '2.0.0');
define('CEO_NAME', 'CEO MANAGER PRO');
define('CEO_AUTHOR', '@ReyRs_VIPro');
define('SESSION_TIMEOUT', 3600);

define('CEO_USER', '$PANEL_USER');
define('CEO_PASS', '$PANEL_HASH');

define('LOG_FILE', __DIR__ . '/../logs/panel.log');
define('ACCESS_LOG', __DIR__ . '/../logs/access.log');
define('ERROR_LOG', __DIR__ . '/../logs/error.log');

define('DEFAULT_SSH_PORT', 22);
define('SSH_TIMEOUT', 10);
?>
EOF
        print_status "Config.php" "ok" "Creado exitosamente"
    fi
    
    # Crear archivos de log
    touch $INSTALL_DIR/logs/{panel,access,error}.log 2>/dev/null
    print_status "Logs" "ok" "Archivos de log creados"
    
    echo ""
}

# ====================================================
# CONFIGURACIÃ“N DE NGINX
# ====================================================

configure_nginx() {
    print_message "Configurando Nginx..."
    
    # Verificar PHP-FPM
    PHP_SOCK=""
    if [[ -S /var/run/php/php8.1-fpm.sock ]]; then
        PHP_SOCK="/var/run/php/php8.1-fpm.sock"
        print_status "PHP-FPM" "ok" "php8.1-fpm"
    elif [[ -S /var/run/php/php7.4-fpm.sock ]]; then
        PHP_SOCK="/var/run/php/php7.4-fpm.sock"
        print_status "PHP-FPM" "ok" "php7.4-fpm"
    else
        print_status "PHP-FPM" "warning" "Socket no encontrado"
        PHP_SOCK="/var/run/php/php8.1-fpm.sock"
    fi
    
    # Crear configuraciÃ³n de Nginx
    cat > $NGINX_CONF << EOF
server {
    listen $PANEL_PORT;
    server_name _;
    
    root $INSTALL_DIR;
    index index.html index.php login.php;
    
    access_log $INSTALL_DIR/logs/access.log;
    error_log $INSTALL_DIR/logs/error.log;
    
    location / {
        try_files \$uri \$uri/ =404;
    }
    
    location ~ \.php$ {
        include fastcgi_params;
        fastcgi_pass unix:$PHP_SOCK;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME \$document_root\$fastcgi_script_name;
    }
    
    location ~ /\.ht {
        deny all;
    }
    
    location ~* \.(jpg|jpeg|png|gif|ico|css|js)$ {
        expires 1y;
        add_header Cache-Control "public, no-transform";
    }
}
EOF
    
    # Habilitar sitio
    mkdir -p /etc/nginx/sites-enabled
    ln -sf $NGINX_CONF /etc/nginx/sites-enabled/
    rm -f /etc/nginx/sites-enabled/default
    
    # Verificar configuraciÃ³n
    nginx -t >> $LOG_FILE 2>&1
    if [[ $? -eq 0 ]]; then
        print_status "Nginx config" "ok" "ConfiguraciÃ³n vÃ¡lida"
    else
        print_status "Nginx config" "failed" "Error en configuraciÃ³n"
        nginx -t
    fi
    
    # Reiniciar Nginx
    systemctl restart nginx >> $LOG_FILE 2>&1
    if systemctl is-active --quiet nginx; then
        print_status "Nginx service" "ok" "Activo en puerto $PANEL_PORT"
    else
        print_status "Nginx service" "failed" "No se pudo iniciar"
    fi
    
    echo ""
}

# ====================================================
# CONFIGURACIÃ“N DE FIREWALL
# ====================================================

configure_firewall() {
    print_message "Configurando firewall..."
    
    if command -v ufw &> /dev/null; then
        # Configurar UFW
        ufw allow $PANEL_PORT/tcp >> $LOG_FILE 2>&1
        ufw allow ssh >> $LOG_FILE 2>&1
        ufw allow 22/tcp >> $LOG_FILE 2>&1
        
        # Habilitar UFW (no interactivo)
        echo "y" | ufw enable >> $LOG_FILE 2>&1
        
        if ufw status | grep -q "Status: active"; then
            print_status "UFW" "ok" "Activo, puerto $PANEL_PORT abierto"
        else
            print_status "UFW" "warning" "Configurado pero no activo"
        fi
    else
        print_status "Firewall" "warning" "UFW no instalado"
    fi
    
    echo ""
}

# ====================================================
# CONFIGURACIÃ“N DE PERMISOS
# ====================================================

set_permissions() {
    print_message "Estableciendo permisos..."
    
    # Cambiar propietario
    chown -R www-data:www-data $INSTALL_DIR 2>/dev/null
    if [[ $? -eq 0 ]]; then
        print_status "Propietario" "ok" "www-data"
    else
        print_status "Propietario" "warning" "Error al cambiar"
    fi
    
    # Permisos de directorios
    find $INSTALL_DIR -type d -exec chmod 755 {} \; 2>/dev/null
    find $INSTALL_DIR -type f -exec chmod 644 {} \; 2>/dev/null
    
    # Permisos especiales
    chmod 750 $INSTALL_DIR/includes 2>/dev/null
    chmod 640 $INSTALL_DIR/includes/config.php 2>/dev/null
    chmod 666 $INSTALL_DIR/logs/*.log 2>/dev/null
    
    print_status "Permisos" "ok" "Configurados correctamente"
    echo ""
}

# ====================================================
# CREAR COMANDOS
# ====================================================

create_commands() {
    print_message "Creando comandos del sistema..."
    
    # Comando 'ceo' para abrir el panel
    cat > /usr/local/bin/ceo << EOF
#!/bin/bash
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
PURPLE='\033[0;35m'
NC='\033[0m'

echo -e "\${PURPLE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\${NC}"
echo -e "\${PURPLE}â•‘         CEO MANAGER PRO - @ReyRs_VIPro    â•‘\${NC}"
echo -e "\${PURPLE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\${NC}"
echo ""

# Cargar configuraciÃ³n
if [[ -f "$INSTALL_DIR/includes/config.php" ]]; then
    USER="$PANEL_USER"
    PORT="$PANEL_PORT"
    IP="$IP_ADDRESS"
else
    # Si no existe, intentar obtener de la instalaciÃ³n
    USER="$PANEL_USER"
    PORT="$PANEL_PORT"
    IP="$IP_ADDRESS"
fi

echo -e "\${YELLOW}ðŸ“Œ URL:\${NC}     http://\$IP:\$PORT"
echo -e "\${YELLOW}ðŸ‘¤ Usuario:\${NC} \$USER"
echo -e "\${YELLOW}ðŸ”‘ Pass:\${NC}    $PANEL_PASS_CLEAR"
echo ""

if command -v xdg-open &> /dev/null; then
    xdg-open "http://\$IP:\$PORT" 2>/dev/null
    echo -e "\${GREEN}âœ… Abriendo panel en tu navegador...\${NC}"
elif command -v sensible-browser &> /dev/null; then
    sensible-browser "http://\$IP:\$PORT" 2>/dev/null
    echo -e "\${GREEN}âœ… Abriendo panel en tu navegador...\${NC}"
else
    echo -e "\${CYAN}ðŸŒ Abre esta URL en tu navegador:\${NC}"
    echo -e "\${BLUE}http://\$IP:\$PORT\${NC}"
fi
EOF
    
    chmod +x /usr/local/bin/ceo
    
    # Comando 'manager' para menÃº de administraciÃ³n
    cat > /usr/local/bin/manager << 'EOF'
#!/bin/bash

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m'

INSTALL_DIR="/var/www/ceo-manager"
LOG_FILE="/var/log/ceo-install.log"

show_menu() {
    clear
    echo -e "${PURPLE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${PURPLE}â•‘         CEO MANAGER PRO - MENÃš            â•‘${NC}"
    echo -e "${PURPLE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo -e "${YELLOW}ESTADO DEL PANEL:${NC}"
    
    # Verificar estado de servicios
    if systemctl is-active --quiet nginx; then
        echo -e "  ${GREEN}âœ“${NC} Nginx: ${GREEN}Activo${NC}"
    else
        echo -e "  ${RED}âœ—${NC} Nginx: ${RED}Inactivo${NC}"
    fi
    
    if [[ -d "$INSTALL_DIR" ]]; then
        echo -e "  ${GREEN}âœ“${NC} Panel: ${GREEN}Instalado${NC}"
    else
        echo -e "  ${RED}âœ—${NC} Panel: ${RED}No instalado${NC}"
    fi
    
    # Verificar puerto
    if ss -tlnp | grep -q ":8080 "; then
        echo -e "  ${GREEN}âœ“${NC} Puerto 8080: ${GREEN}Escuchando${NC}"
    else
        echo -e "  ${YELLOW}âš ${NC} Puerto 8080: ${YELLOW}No detectado${NC}"
    fi
    
    echo ""
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${YELLOW}OPCIONES DISPONIBLES:${NC}"
    echo ""
    echo -e "  ${GREEN}1)${NC} Abrir panel en navegador (ceo)"
    echo -e "  ${GREEN}2)${NC} Ver logs del panel"
    echo -e "  ${GREEN}3)${NC} Ver errores del panel"
    echo -e "  ${GREEN}4)${NC} Reiniciar panel (nginx + php)"
    echo -e "  ${GREEN}5)${NC} Detener panel"
    echo -e "  ${GREEN}6)${NC} Iniciar panel"
    echo -e "  ${GREEN}7)${NC} Ver configuraciÃ³n"
    echo -e "  ${GREEN}8)${NC} Desinstalar panel"
    echo -e "  ${GREEN}9)${NC} Cambiar contraseÃ±a"
    echo -e "  ${GREEN}0)${NC} Salir"
    echo ""
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    read -p "Selecciona una opciÃ³n: " OPTION
}

while true; do
    show_menu
    
    case $OPTION in
        1)
            ceo
            read -p "Presiona Enter para continuar..."
            ;;
        2)
            echo ""
            echo -e "${YELLOW}Ãšltimas 20 lÃ­neas del log:${NC}"
            tail -20 $INSTALL_DIR/logs/panel.log 2>/dev/null || echo "No hay logs"
            echo ""
            read -p "Presiona Enter para continuar..."
            ;;
        3)
            echo ""
            echo -e "${YELLOW}Ãšltimos errores:${NC}"
            tail -20 $INSTALL_DIR/logs/error.log 2>/dev/null || echo "No hay errores"
            echo ""
            read -p "Presiona Enter para continuar..."
            ;;
        4)
            echo ""
            echo -e "${YELLOW}Reiniciando panel...${NC}"
            systemctl restart nginx
            systemctl restart php*-fpm
            echo -e "${GREEN}âœ… Panel reiniciado${NC}"
            sleep 2
            ;;
        5)
            echo ""
            echo -e "${YELLOW}Deteniendo panel...${NC}"
            systemctl stop nginx
            systemctl stop php*-fpm
            echo -e "${GREEN}âœ… Panel detenido${NC}"
            sleep 2
            ;;
        6)
            echo ""
            echo -e "${YELLOW}Iniciando panel...${NC}"
            systemctl start nginx
            systemctl start php*-fpm
            echo -e "${GREEN}âœ… Panel iniciado${NC}"
            sleep 2
            ;;
        7)
            echo ""
            echo -e "${YELLOW}ConfiguraciÃ³n actual:${NC}"
            echo "  Directorio: $INSTALL_DIR"
            if [[ -f "$INSTALL_DIR/includes/config.php" ]]; then
                grep "define" $INSTALL_DIR/includes/config.php | head -10
            else
                echo "  No se encontrÃ³ archivo de configuraciÃ³n"
            fi
            echo ""
            read -p "Presiona Enter para continuar..."
            ;;
        8)
            echo ""
            echo -e "${RED}âš ï¸  ATENCIÃ“N: Esto eliminarÃ¡ todo el panel${NC}"
            read -p "Â¿EstÃ¡s seguro? (escribe 'DESINSTALAR' para confirmar): " CONFIRM
            if [[ "$CONFIRM" == "DESINSTALAR" ]]; then
                echo -e "${YELLOW}Desinstalando panel...${NC}"
                systemctl stop nginx
                rm -rf $INSTALL_DIR
                rm -f /etc/nginx/sites-available/ceo-manager
                rm -f /etc/nginx/sites-enabled/ceo-manager
                systemctl restart nginx
                echo -e "${GREEN}âœ… Panel desinstalado${NC}"
                sleep 2
            else
                echo -e "${YELLOW}DesinstalaciÃ³n cancelada${NC}"
                sleep 2
            fi
            ;;
        9)
            echo ""
            echo -e "${YELLOW}Cambiar contraseÃ±a del panel${NC}"
            read -s -p "Nueva contraseÃ±a: " NEW_PASS
            echo ""
            read -s -p "Confirmar: " NEW_PASS2
            echo ""
            
            if [[ "$NEW_PASS" == "$NEW_PASS2" ]] && [[ -n "$NEW_PASS" ]]; then
                NEW_HASH=$(php -r "echo password_hash('$NEW_PASS', PASSWORD_DEFAULT);")
                sed -i "s|define('CEO_PASS', '.*');|define('CEO_PASS', '$NEW_HASH');|" $INSTALL_DIR/includes/config.php
                echo -e "${GREEN}âœ… ContraseÃ±a actualizada${NC}"
            else
                echo -e "${RED}âŒ Las contraseÃ±as no coinciden${NC}"
            fi
            sleep 2
            ;;
        0)
            echo -e "${GREEN}Â¡Hasta luego!${NC}"
            exit 0
            ;;
        *)
            echo -e "${RED}OpciÃ³n invÃ¡lida${NC}"
            sleep 2
            ;;
    esac
done
EOF
    
    chmod +x /usr/local/bin/manager
    
    print_status "Comando ceo" "ok" "Creado: ceo"
    print_status "Comando manager" "ok" "Creado: manager"
    echo ""
}

# ====================================================
# PRUEBAS FINALES
# ====================================================

test_panel() {
    print_message "Verificando instalaciÃ³n..."
    
    # Verificar archivos principales
    if [[ -f "$INSTALL_DIR/login.php" ]]; then
        print_status "login.php" "ok" "Encontrado"
    else
        print_status "login.php" "warning" "No encontrado"
    fi
    
    if [[ -f "$INSTALL_DIR/index.html" ]]; then
        print_status "index.html" "ok" "Encontrado"
    else
        print_status "index.html" "warning" "No encontrado"
    fi
    
    if [[ -f "$INSTALL_DIR/includes/config.php" ]]; then
        print_status "config.php" "ok" "Encontrado"
    else
        print_status "config.php" "failed" "No encontrado"
    fi
    
    # Probar conexiÃ³n local
    if command -v curl &> /dev/null; then
        curl -s -o /dev/null -w "%{http_code}" http://localhost:$PANEL_PORT/ > /tmp/curl-test 2>/dev/null
        HTTP_CODE=$(cat /tmp/curl-test)
        
        if [[ "$HTTP_CODE" == "200" ]] || [[ "$HTTP_CODE" == "302" ]] || [[ "$HTTP_CODE" == "301" ]]; then
            print_status "ConexiÃ³n local" "ok" "Panel responde (HTTP $HTTP_CODE)"
        else
            print_status "ConexiÃ³n local" "warning" "No responde (HTTP $HTTP_CODE)"
        fi
        rm -f /tmp/curl-test
    fi
    
    echo ""
}

# ====================================================
# LIMPIEZA
# ====================================================

cleanup() {
    print_message "Limpiando archivos temporales..."
    rm -rf /tmp/ceo-install
    print_status "Limpieza" "ok" "Temporales eliminados"
    echo ""
}

# ====================================================
# MOSTRAR RESUMEN
# ====================================================

show_summary() {
    clear
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘         INSTALACIÃ“N COMPLETADA EXITOSAMENTE               â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    
    # Mostrar resumen de instalaciÃ³n
    echo -e "${PURPLE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${YELLOW}ðŸ“Š RESUMEN DE INSTALACIÃ“N:${NC}"
    
    for component in "${!INSTALL_STATUS[@]}"; do
        status="${INSTALL_STATUS[$component]}"
        if [[ "$status" == "OK" ]]; then
            echo -e "  ${GREEN}âœ“${NC} $component"
        elif [[ "$status" == "WARNING" ]]; then
            echo -e "  ${YELLOW}âš ${NC} $component"
        else
            echo -e "  ${RED}âœ—${NC} $component"
        fi
    done
    
    echo -e "${PURPLE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    
    # Mostrar datos de acceso (CON CONTRASEÃ‘A VISIBLE)
    echo -e "${YELLOW}ðŸ“‹ DATOS DE ACCESO (GUARDAR):${NC}"
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "  ${WHITE}ðŸŒ URL:${NC}         http://$IP_ADDRESS:$PANEL_PORT"
    echo -e "  ${WHITE}ðŸ‘¤ Usuario:${NC}     $PANEL_USER"
    echo -e "  ${WHITE}ðŸ”‘ ContraseÃ±a:${NC}  $PANEL_PASS_CLEAR"
    echo -e "  ${WHITE}âš¡ Comando:${NC}      ceo"
    echo -e "  ${WHITE}âš™ï¸  Manager:${NC}     manager"
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    
    # Guardar credenciales en archivo
    cat > /root/ceo-credentials.txt << EOF
=== CEO MANAGER PRO ===
URL: http://$IP_ADDRESS:$PANEL_PORT
Usuario: $PANEL_USER
ContraseÃ±a: $PANEL_PASS_CLEAR
Puerto: $PANEL_PORT
Comandos: ceo | manager
InstalaciÃ³n: $(date)
=======================
EOF
    chmod 600 /root/ceo-credentials.txt
    
    echo -e "${YELLOW}ðŸ“‚ Credenciales guardadas en:${NC} /root/ceo-credentials.txt"
    echo ""
    
    # Mostrar comandos Ãºtiles
    echo -e "${YELLOW}ðŸ“Š COMANDOS DISPONIBLES:${NC}"
    echo -e "  ${CYAN}â–¶${NC} ${GREEN}ceo${NC}      - Abrir panel en navegador"
    echo -e "  ${CYAN}â–¶${NC} ${GREEN}manager${NC}  - MenÃº de administraciÃ³n"
    echo -e "  ${CYAN}â–¶${NC} ${GREEN}cat /root/ceo-credentials.txt${NC} - Ver credenciales"
    echo ""
    
    # Verificar si hubo fallos
    FAILED_COUNT=0
    for status in "${INSTALL_STATUS[@]}"; do
        if [[ "$status" == "FAILED" ]]; then
            FAILED_COUNT=$((FAILED_COUNT + 1))
        fi
    done
    
    if [[ $FAILED_COUNT -gt 0 ]]; then
        echo -e "${YELLOW}âš ï¸  Algunos componentes fallaron pero la instalaciÃ³n continuÃ³${NC}"
        echo -e "${YELLOW}   Revisa los logs: tail -f $LOG_FILE${NC}"
        echo ""
    fi
    
    echo -e "${GREEN}âœ… Panel instalado por @ReyRs_VIPro${NC}"
    echo -e "${YELLOW}âš ï¸  Guarda estos datos en un lugar seguro${NC}"
    echo ""
}

# ====================================================
# FUNCIÃ“N PRINCIPAL
# ====================================================

main() {
    print_banner
    check_root
    get_ip
    check_system
    get_config
    install_dependencies
    download_panel
    configure_panel
    configure_nginx
    configure_firewall
    set_permissions
    create_commands
    test_panel
    cleanup
    show_summary
    
    log "InstalaciÃ³n completada - Usuario: $PANEL_USER - Puerto: $PANEL_PORT"
    
    # Preguntar si quiere abrir el panel ahora
    echo ""
    read -p "Â¿Quieres abrir el panel ahora? (s/n): " OPEN_NOW
    if [[ "$OPEN_NOW" =~ ^[Ss]$ ]]; then
        ceo
    fi
    
    echo ""
    echo -e "${GREEN}Para acceder al menÃº de administraciÃ³n, escribe: manager${NC}"
    echo ""
}

# ====================================================
# EJECUTAR
# ====================================================

# Inicializar archivo de log
touch $LOG_FILE
chmod 666 $LOG_FILE

# Ejecutar funciÃ³n principal
main
