#!/bin/bash

# SSH VPS MANAGER - INSTALADOR AUTOMÃTICO
# VersiÃ³n: 2.0

# Colores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
WHITE='\033[1;37m'
NC='\033[0m'

# ConfiguraciÃ³n
INSTALL_DIR="/var/www/ssh-panel"
NGINX_CONF="/etc/nginx/sites-available/ssh-panel"
PANEL_ZIP_URL="https://github.com/RmXF/Dev/raw/main/ssh-v1.zip"
LOG_FILE="/tmp/ssh-panel-install.log"
PANEL_PORT=""
PANEL_USER=""
PANEL_PASS=""

# FunciÃ³n para imprimir mensajes
print_banner() {
    clear
    echo -e "${PURPLE}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘                                                              â•‘"
    echo "â•‘              SSH VPS MANAGER - INSTALADOR v2.0              â•‘"
    echo "â•‘                                                              â•‘"
    echo "â•‘         Panel de administraciÃ³n de usuarios SSH             â•‘"
    echo "â•‘                                                              â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
    echo ""
}

print_message() {
    echo -e "${BLUE}[SSH-PANEL]${NC} $1"
}

print_success() {
    echo -e "${GREEN}[âœ“]${NC} $1"
}

print_error() {
    echo -e "${RED}[âœ—]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[!]${NC} $1"
}

print_info() {
    echo -e "${CYAN}[i]${NC} $1"
}

# FunciÃ³n para loguear
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >> $LOG_FILE
}

# Verificar si se ejecuta como root
check_root() {
    if [[ $EUID -ne 0 ]]; then
        print_error "Este script debe ejecutarse como root"
        echo -e "${YELLOW}Ejecuta: sudo bash $0${NC}"
        exit 1
    fi
}

# Verificar sistema operativo
check_system() {
    print_info "Verificando sistema operativo..."
    
    if [[ -f /etc/os-release ]]; then
        . /etc/os-release
        OS=$ID
        OS_NAME=$NAME
        OS_VERSION=$VERSION_ID
        print_success "Sistema detectado: $OS_NAME $OS_VERSION"
    else
        print_error "No se pudo detectar el sistema operativo"
        exit 1
    fi
    
    # Verificar arquitectura
    ARCH=$(uname -m)
    print_info "Arquitectura: $ARCH"
    
    # Verificar espacio en disco
    REQUIRED_SPACE=500 # MB
    AVAILABLE_SPACE=$(df / | awk 'NR==2 {print $4}')
    AVAILABLE_SPACE_MB=$((AVAILABLE_SPACE / 1024))
    
    if [[ $AVAILABLE_SPACE_MB -lt $REQUIRED_SPACE ]]; then
        print_error "Espacio insuficiente. Requerido: ${REQUIRED_SPACE}MB, Disponible: ${AVAILABLE_SPACE_MB}MB"
        exit 1
    fi
    print_success "Espacio en disco: ${AVAILABLE_SPACE_MB}MB disponible"
    
    # Verificar memoria RAM
    TOTAL_RAM=$(free -m | awk '/^Mem:/{print $2}')
    if [[ $TOTAL_RAM -lt 512 ]]; then
        print_warning "Memoria RAM baja (${TOTAL_RAM}MB). El panel puede funcionar lento."
    else
        print_success "Memoria RAM: ${TOTAL_RAM}MB"
    fi
}

# Solicitar configuraciÃ³n
get_config() {
    echo ""
    print_warning "CONFIGURACIÃ“N DEL PANEL"
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    
    # Usuario
    while true; do
        read -p "ğŸ‘¤ Usuario administrador: " PANEL_USER
        if [[ -z "$PANEL_USER" ]]; then
            print_error "El usuario no puede estar vacÃ­o"
        elif [[ ! "$PANEL_USER" =~ ^[a-zA-Z0-9_]+$ ]]; then
            print_error "Usuario invÃ¡lido. Solo letras, nÃºmeros y guiÃ³n bajo"
        else
            break
        fi
    done
    
    # ContraseÃ±a
    while true; do
        echo -n "ğŸ”‘ ContraseÃ±a: "
        read -s PANEL_PASS
        echo ""
        
        echo -n "ğŸ”’ Confirmar contraseÃ±a: "
        read -s PANEL_PASS_CONFIRM
        echo ""
        
        if [[ -z "$PANEL_PASS" ]]; then
            print_error "La contraseÃ±a no puede estar vacÃ­a"
        elif [[ "$PANEL_PASS" != "$PANEL_PASS_CONFIRM" ]]; then
            print_error "Las contraseÃ±as no coinciden"
        elif [[ ${#PANEL_PASS} -lt 6 ]]; then
            print_error "La contraseÃ±a debe tener al menos 6 caracteres"
        else
            break
        fi
    done
    
    # Puerto
    echo ""
    read -p "ğŸ”Œ Puerto para el panel (default: 8080): " PANEL_PORT_INPUT
    PANEL_PORT=${PANEL_PORT_INPUT:-8080}
    
    if ! [[ "$PANEL_PORT" =~ ^[0-9]+$ ]] || [[ "$PANEL_PORT" -lt 1 ]] || [[ "$PANEL_PORT" -gt 65535 ]]; then
        print_error "Puerto invÃ¡lido. Usando puerto 8080"
        PANEL_PORT=8080
    fi
    
    # Email (opcional)
    echo ""
    read -p "ğŸ“§ Email del administrador (opcional): " PANEL_EMAIL
    
    # Resumen
    echo ""
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${YELLOW}RESUMEN DE INSTALACIÃ“N:${NC}"
    echo "  ğŸ“Œ Usuario: $PANEL_USER"
    echo "  ğŸ“Œ Puerto: $PANEL_PORT"
    echo "  ğŸ“Œ Directorio: $INSTALL_DIR"
    echo "  ğŸ“Œ Log: $LOG_FILE"
    [[ -n "$PANEL_EMAIL" ]] && echo "  ğŸ“§ Email: $PANEL_EMAIL"
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    
    read -p "Â¿Continuar con la instalaciÃ³n? (s/n): " CONFIRM
    if [[ ! "$CONFIRM" =~ ^[Ss]$ ]]; then
        print_error "InstalaciÃ³n cancelada"
        exit 0
    fi
}

# Instalar dependencias
install_dependencies() {
    print_message "Instalando dependencias necesarias..."
    log "Iniciando instalaciÃ³n de dependencias"
    
    # Actualizar repositorios
    apt-get update -y >> $LOG_FILE 2>&1
    
    # Instalar dependencias bÃ¡sicas
    apt-get install -y \
        curl \
        wget \
        git \
        unzip \
        tar \
        software-properties-common \
        apt-transport-https \
        ca-certificates \
        gnupg \
        lsb-release \
        >> $LOG_FILE 2>&1
    
    # Instalar Nginx
    apt-get install -y nginx >> $LOG_FILE 2>&1
    
    # Instalar PHP 8.1
    add-apt-repository ppa:ondrej/php -y >> $LOG_FILE 2>&1
    apt-get update -y >> $LOG_FILE 2>&1
    
    apt-get install -y \
        php8.1 \
        php8.1-fpm \
        php8.1-cli \
        php8.1-common \
        php8.1-mbstring \
        php8.1-xml \
        php8.1-curl \
        php8.1-zip \
        php8.1-gd \
        php8.1-mysql \
        php8.1-bcmath \
        php8.1-json \
        php8.1-tokenizer \
        >> $LOG_FILE 2>&1
    
    # Instalar utilidades SSH
    apt-get install -y \
        sshpass \
        openssh-server \
        openssh-client \
        >> $LOG_FILE 2>&1
    
    # Instalar herramientas de red
    apt-get install -y \
        net-tools \
        lsof \
        iptables \
        ufw \
        fail2ban \
        >> $LOG_FILE 2>&1
    
    print_success "Dependencias instaladas correctamente"
    log "Dependencias instaladas"
}

# Crear estructura de directorios
create_directories() {
    print_message "Creando estructura de directorios..."
    
    # Directorios principales
    mkdir -p $INSTALL_DIR
    mkdir -p $INSTALL_DIR/php/endpoints
    mkdir -p $INSTALL_DIR/js
    mkdir -p $INSTALL_DIR/css
    mkdir -p $INSTALL_DIR/includes
    mkdir -p $INSTALL_DIR/logs
    mkdir -p $INSTALL_DIR/backups
    mkdir -p $INSTALL_DIR/temp
    mkdir -p $INSTALL_DIR/assets
    mkdir -p $INSTALL_DIR/assets/img
    mkdir -p $INSTALL_DIR/assets/fonts
    
    # Establecer permisos
    chmod 755 $INSTALL_DIR
    chmod 755 $INSTALL_DIR/php
    chmod 755 $INSTALL_DIR/php/endpoints
    chmod 755 $INSTALL_DIR/js
    chmod 755 $INSTALL_DIR/css
    chmod 750 $INSTALL_DIR/includes
    chmod 750 $INSTALL_DIR/logs
    chmod 755 $INSTALL_DIR/backups
    chmod 755 $INSTALL_DIR/temp
    chmod 755 $INSTALL_DIR/assets
    
    print_success "Directorios creados"
    log "Estructura de directorios creada"
}

# Descargar panel
download_panel() {
    print_message "Descargando panel SSH..."
    log "Descargando panel desde $PANEL_ZIP_URL"
    
    cd /tmp
    rm -rf panel-install 2>/dev/null
    mkdir panel-install
    cd panel-install
    
    # Descargar con wget
    if ! wget -O panel.zip $PANEL_ZIP_URL >> $LOG_FILE 2>&1; then
        # Si falla wget, intentar con curl
        if ! curl -L -o panel.zip $PANEL_ZIP_URL >> $LOG_FILE 2>&1; then
            print_error "No se pudo descargar el panel"
            log "Error: FallÃ³ la descarga del panel"
            exit 1
        fi
    fi
    
    # Verificar descarga
    if [[ ! -f "panel.zip" ]] || [[ ! -s "panel.zip" ]]; then
        print_error "Archivo descargado vacÃ­o o corrupto"
        log "Error: Archivo zip vacÃ­o o corrupto"
        exit 1
    fi
    
    # Descomprimir
    if ! unzip -o panel.zip >> $LOG_FILE 2>&1; then
        print_error "Error al descomprimir el panel"
        log "Error: FallÃ³ la descompresiÃ³n del zip"
        exit 1
    fi
    
    print_success "Panel descargado correctamente"
    log "Panel descargado y descomprimido"
}

# Crear archivo login.php
create_login_file() {
    print_message "Creando archivo login.php..."
    
    cat > $INSTALL_DIR/login.php << 'EOF'
<?php
session_start();

// Redirigir si ya estÃ¡ logueado
if (isset($_SESSION['panel_logged_in']) && $_SESSION['panel_logged_in'] === true) {
    header('Location: index.html');
    exit();
}

// Archivo de configuraciÃ³n
define('CONFIG_FILE', __DIR__ . '/includes/config.php');

// Cargar configuraciÃ³n
if (file_exists(CONFIG_FILE)) {
    require_once CONFIG_FILE;
}

$error = '';
$success = '';

// Procesar login
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $username = $_POST['username'] ?? '';
    $password = $_POST['password'] ?? '';
    
    if ($username === PANEL_USER && password_verify($password, PANEL_PASS)) {
        $_SESSION['panel_logged_in'] = true;
        $_SESSION['username'] = $username;
        $_SESSION['login_time'] = time();
        $_SESSION['last_activity'] = time();
        $_SESSION['ip'] = $_SERVER['REMOTE_ADDR'];
        
        // Registrar login
        $log_entry = date('Y-m-d H:i:s') . " - Login exitoso - Usuario: $username - IP: " . $_SERVER['REMOTE_ADDR'] . "\n";
        file_put_contents(__DIR__ . '/logs/panel.log', $log_entry, FILE_APPEND);
        
        header('Location: index.html');
        exit();
    } else {
        $error = 'Usuario o contraseÃ±a incorrectos';
        
        // Registrar intento fallido
        $log_entry = date('Y-m-d H:i:s') . " - Intento fallido - Usuario: $username - IP: " . $_SERVER['REMOTE_ADDR'] . "\n";
        file_put_contents(__DIR__ . '/logs/panel.log', $log_entry, FILE_APPEND);
    }
}
?>
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SSH VPS Manager - Login</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .login-container {
            width: 100%;
            max-width: 450px;
            animation: fadeInUp 0.6s ease;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .login-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .login-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 40px 30px;
            text-align: center;
            color: white;
        }

        .login-header i {
            font-size: 3.5rem;
            margin-bottom: 15px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .login-header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .login-body {
            padding: 40px 30px;
        }

        .form-group {
            margin-bottom: 25px;
            position: relative;
        }

        .form-group i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #667eea;
            font-size: 1.1rem;
        }

        .form-group input {
            width: 100%;
            padding: 15px 15px 15px 45px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
        }

        .password-toggle {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: #667eea;
            z-index: 10;
        }

        .btn-login {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-login:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }

        .alert {
            padding: 15px 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: shake 0.5s ease;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .alert-error {
            background: #fee;
            color: #c33;
            border-left: 4px solid #c33;
        }

        .alert-success {
            background: #efe;
            color: #3c3;
            border-left: 4px solid #3c3;
        }
    </style>
</head>
<body>
    <div class="login-container">
        <div class="login-card">
            <div class="login-header">
                <i class="fas fa-terminal"></i>
                <h1>SSH VPS Manager</h1>
                <p>Panel de administraciÃ³n de usuarios SSH</p>
            </div>
            
            <div class="login-body">
                <?php if ($error): ?>
                    <div class="alert alert-error">
                        <i class="fas fa-exclamation-circle"></i>
                        <span><?php echo htmlspecialchars($error); ?></span>
                    </div>
                <?php endif; ?>
                
                <form method="POST" action="" id="loginForm">
                    <div class="form-group">
                        <i class="fas fa-user"></i>
                        <input type="text" name="username" placeholder="Usuario" required autofocus>
                    </div>
                    
                    <div class="form-group">
                        <i class="fas fa-lock"></i>
                        <input type="password" name="password" placeholder="ContraseÃ±a" required id="password">
                        <i class="fas fa-eye password-toggle" id="togglePassword"></i>
                    </div>
                    
                    <button type="submit" class="btn-login" id="loginBtn">
                        <i class="fas fa-sign-in-alt"></i> Ingresar al Panel
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Toggle password visibility
        document.getElementById('togglePassword').addEventListener('click', function() {
            const password = document.getElementById('password');
            const type = password.type === 'password' ? 'text' : 'password';
            password.type = type;
            this.classList.toggle('fa-eye');
            this.classList.toggle('fa-eye-slash');
        });

        // Loading animation
        document.getElementById('loginForm').addEventListener('submit', function() {
            const btn = document.getElementById('loginBtn');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verificando...';
            btn.disabled = true;
        });
    </script>
</body>
</html>
EOF

    print_success "Archivo login.php creado"
    log "login.php creado correctamente"
}

# Crear archivo logout.php
create_logout_file() {
    print_message "Creando archivo logout.php..."
    
    cat > $INSTALL_DIR/logout.php << 'EOF'
<?php
session_start();
session_unset();
session_destroy();
header('Location: login.php');
exit();
?>
EOF

    print_success "Archivo logout.php creado"
}

# Crear archivo check_session.php
create_check_session() {
    print_message "Creando verificador de sesiÃ³n..."
    
    cat > $INSTALL_DIR/includes/check_session.php << 'EOF'
<?php
session_start();
header('Content-Type: application/json');

if (isset($_SESSION['panel_logged_in']) && $_SESSION['panel_logged_in'] === true) {
    echo json_encode(['logged_in' => true, 'user' => $_SESSION['username']]);
} else {
    echo json_encode(['logged_in' => false]);
}
?>
EOF

    print_success "check_session.php creado"
}

# Crear archivo de configuraciÃ³n
create_config_file() {
    print_message "Creando archivo de configuraciÃ³n..."
    
    # Generar hash de la contraseÃ±a
    PHP_HASH=$(php -r "echo password_hash('$PANEL_PASS', PASSWORD_DEFAULT);")
    
    cat > $INSTALL_DIR/includes/config.php << EOF
<?php
// ConfiguraciÃ³n del panel SSH
define('PANEL_VERSION', '2.0.0');
define('PANEL_NAME', 'SSH VPS Manager');
define('SESSION_TIMEOUT', 3600); // 1 hora
define('MAX_LOGIN_ATTEMPTS', 5);
define('LOGIN_TIMEOUT', 900); // 15 minutos

// Credenciales del panel
define('PANEL_USER', '$PANEL_USER');
define('PANEL_PASS', '$PHP_HASH');

// ConfiguraciÃ³n de seguridad
define('ALLOWED_IPS', serialize(['*']));
define('ENABLE_2FA', false);
define('SESSION_NAME', 'SSH_PANEL_SESSION');

// ConfiguraciÃ³n de logging
define('LOG_LOGINS', true);
define('LOG_ACTIONS', true);
define('LOG_FILE', __DIR__ . '/../logs/panel.log');

// ConfiguraciÃ³n de conexiÃ³n SSH
define('DEFAULT_SSH_PORT', 22);
define('SSH_TIMEOUT', 10);
define('SSH_MAX_ATTEMPTS', 3);

// InformaciÃ³n de instalaciÃ³n
define('INSTALL_DATE', '$(date)');
define('PANEL_URL', 'http://$(curl -s ifconfig.me):$PANEL_PORT');
EOF

    print_success "Archivo de configuraciÃ³n creado"
}

# Crear archivo .htaccess
create_htaccess() {
    print_message "Creando archivo .htaccess..."
    
    cat > $INSTALL_DIR/.htaccess << 'EOF'
# Proteger archivos sensibles
<FilesMatch "^\.">
    Order allow,deny
    Deny from all
</FilesMatch>

# Proteger includes
<IfModule mod_rewrite.c>
    RewriteRule ^includes/.*$ - [F,L]
</IfModule>

# Deshabilitar listado de directorios
Options -Indexes

# Redirigir a login si no estÃ¡ autenticado
RewriteEngine On
RewriteCond %{REQUEST_URI} !^/login\.php
RewriteCond %{REQUEST_URI} !^/logout\.php
RewriteCond %{REQUEST_URI} !^/includes/check_session\.php
RewriteCond %{REQUEST_URI} !\.(css|js|png|jpg|jpeg|gif|ico)$
RewriteCond %{HTTP_COOKIE} !PHPSESSID [NC]
RewriteRule ^(.*)$ /login.php [R=302,L]

# Cache de archivos estÃ¡ticos
<FilesMatch "\.(css|js|png|jpg|jpeg|gif|ico)$">
    Header set Cache-Control "max-age=2592000, public"
</FilesMatch>
EOF

    print_success ".htaccess creado"
}

# Crear archivo de log inicial
create_log_file() {
    print_message "Creando archivo de logs..."
    
    cat > $INSTALL_DIR/logs/panel.log << EOF
=== LOG DEL PANEL SSH ===
Fecha de instalaciÃ³n: $(date)
Usuario: $PANEL_USER
IP del servidor: $(curl -s ifconfig.me)
Puerto: $PANEL_PORT
=========================

EOF

    print_success "Archivo de log creado"
}

# Modificar index.html para requerir login
modify_index() {
    print_message "Modificando index.html para requerir login..."
    
    # Verificar si existe el archivo
    if [[ -f "$INSTALL_DIR/index.html" ]]; then
        # Hacer backup
        cp $INSTALL_DIR/index.html $INSTALL_DIR/index.html.bak
        
        # Agregar verificaciÃ³n de sesiÃ³n al inicio del body
        sed -i '/<body>/a \
    <script>\
        // Verificar sesiÃ³n\
        fetch("includes/check_session.php")\
            .then(response => response.json())\
            .then(data => {\
                if (!data.logged_in) {\
                    window.location.href = "login.php";\
                }\
            })\
            .catch(() => {\
                window.location.href = "login.php";\
            });\
        \
        // Mantener sesiÃ³n activa\
        setInterval(() => {\
            fetch("includes/check_session.php");\
        }, 60000);\
    </script>' $INSTALL_DIR/index.html
        
        print_success "index.html modificado"
    else
        print_warning "No se encontrÃ³ index.html"
    fi
}

# Copiar archivos del panel
copy_panel_files() {
    print_message "Copiando archivos del panel..."
    
    cd /tmp/panel-install
    
    # Buscar y copiar archivos
    find . -name "*.html" -exec cp {} $INSTALL_DIR/ \; 2>/dev/null
    find . -name "*.php" -not -name "login.php" -exec cp {} $INSTALL_DIR/php/ \; 2>/dev/null
    find . -name "*.js" -exec cp {} $INSTALL_DIR/js/ \; 2>/dev/null
    find . -name "*.css" -exec cp {} $INSTALL_DIR/css/ \; 2>/dev/null
    find . -name "*.png" -o -name "*.jpg" -o -name "*.gif" -exec cp {} $INSTALL_DIR/assets/img/ \; 2>/dev/null
    
    print_success "Archivos del panel copiados"
}

# Configurar Nginx
configure_nginx() {
    print_message "Configurando Nginx..."
    
    cat > $NGINX_CONF << EOF
server {
    listen $PANEL_PORT;
    server_name _;
    
    root $INSTALL_DIR;
    index index.html index.php login.php;
    
    access_log $INSTALL_DIR/logs/access.log;
    error_log $INSTALL_DIR/logs/error.log;
    
    # Seguridad
    server_tokens off;
    
    # CompresiÃ³n
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;
    
    location / {
        try_files \$uri \$uri/ =404;
    }
    
    location ~ \.php$ {
        include fastcgi_params;
        fastcgi_pass unix:/var/run/php/php8.1-fpm.sock;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME \$document_root\$fastcgi_script_name;
    }
    
    location ~ /\.ht {
        deny all;
    }
    
    # Cache de archivos estÃ¡ticos
    location ~* \.(jpg|jpeg|png|gif|ico|css|js)$ {
        expires 1y;
        add_header Cache-Control "public, no-transform";
    }
    
    # Proteger directorios sensibles
    location ~* /(includes|logs|temp)/ {
        deny all;
        return 404;
    }
}
EOF
    
    # Habilitar sitio
    ln -sf $NGINX_CONF /etc/nginx/sites-enabled/
    rm -f /etc/nginx/sites-enabled/default
    
    # Verificar configuraciÃ³n
    nginx -t >> $LOG_FILE 2>&1
    
    if [[ $? -eq 0 ]]; then
        print_success "Nginx configurado correctamente"
    else
        print_error "Error en configuraciÃ³n de Nginx"
        nginx -t
        exit 1
    fi
    
    # Reiniciar Nginx
    systemctl restart nginx >> $LOG_FILE 2>&1
    systemctl restart php8.1-fpm >> $LOG_FILE 2>&1
    
    print_success "Servicios reiniciados"
}

# Configurar firewall
configure_firewall() {
    print_message "Configurando firewall..."
    
    if command -v ufw &> /dev/null; then
        ufw allow $PANEL_PORT/tcp >> $LOG_FILE 2>&1
        ufw allow ssh >> $LOG_FILE 2>&1
        ufw --force enable >> $LOG_FILE 2>&1
        print_success "Firewall UFW configurado"
    elif command -v iptables &> /dev/null; then
        iptables -A INPUT -p tcp --dport $PANEL_PORT -j ACCEPT
        iptables -A INPUT -p tcp --dport 22 -j ACCEPT
        iptables-save > /etc/iptables/rules.v4
        print_success "Firewall iptables configurado"
    fi
}

# Establecer permisos
set_permissions() {
    print_message "Estableciendo permisos..."
    
    # Cambiar propietario
    chown -R www-data:www-data $INSTALL_DIR
    
    # Establecer permisos especÃ­ficos
    find $INSTALL_DIR -type d -exec chmod 755 {} \;
    find $INSTALL_DIR -type f -exec chmod 644 {} \;
    
    # Permisos especiales
    chmod 750 $INSTALL_DIR/includes
    chmod 750 $INSTALL_DIR/logs
    chmod 640 $INSTALL_DIR/includes/config.php
    chmod 640 $INSTALL_DIR/logs/panel.log
    
    print_success "Permisos establecidos"
}

# Crear comando de acceso
create_command() {
    print_message "Creando comando de acceso 'ceo'..."
    
    SERVER_IP=$(curl -s ifconfig.me)
    
    cat > /usr/local/bin/ceo << EOF
#!/bin/bash
echo -e "${GREEN}ğŸŒ Abriendo panel SSH en http://$SERVER_IP:$PANEL_PORT${NC}"
echo -e "${YELLOW}ğŸ‘¤ Usuario: $PANEL_USER${NC}"
echo ""

if command -v xdg-open &> /dev/null; then
    xdg-open "http://$SERVER_IP:$PANEL_PORT" 2>/dev/null
elif command -v sensible-browser &> /dev/null; then
    sensible-browser "http://$SERVER_IP:$PANEL_PORT" 2>/dev/null
else
    echo -e "${CYAN}http://$SERVER_IP:$PANEL_PORT${NC}"
fi
EOF
    
    chmod +x /usr/local/bin/ceo
    print_success "Comando 'ceo' creado"
}

# Mostrar resumen final
show_summary() {
    SERVER_IP=$(curl -s ifconfig.me)
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘         INSTALACIÃ“N COMPLETADA EXITOSAMENTE               â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo -e "${WHITE}ğŸ“‹ DATOS DE ACCESO:${NC}"
    echo -e "  ${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "  ${YELLOW}ğŸŒ URL:${NC}        http://$SERVER_IP:$PANEL_PORT"
    echo -e "  ${YELLOW}ğŸ‘¤ Usuario:${NC}     $PANEL_USER"
    echo -e "  ${YELLOW}ğŸ”‘ ContraseÃ±a:${NC}  (la que ingresaste)"
    echo -e "  ${YELLOW}âš¡ Comando:${NC}      ceo"
    echo -e "  ${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    echo -e "${WHITE}ğŸ“‚ UBICACIÃ“N DE ARCHIVOS:${NC}"
    echo -e "  ${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "  ${YELLOW}ğŸ“ Panel:${NC}        $INSTALL_DIR"
    echo -e "  ${YELLOW}ğŸ“ Logs:${NC}         $INSTALL_DIR/logs/panel.log"
    echo -e "  ${YELLOW}ğŸ“ Config:${NC}       $INSTALL_DIR/includes/config.php"
    echo -e "  ${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    echo -e "${WHITE}ğŸ› ï¸  COMANDOS ÃšTILES:${NC}"
    echo -e "  ${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "  ${YELLOW}â–¶ Ver logs:${NC}       tail -f $INSTALL_DIR/logs/panel.log"
    echo -e "  ${YELLOW}â–¶ Reiniciar:${NC}      systemctl restart nginx"
    echo -e "  ${YELLOW}â–¶ Abrir panel:${NC}    ceo"
    echo -e "  ${YELLOW}â–¶ Ver errores:${NC}    tail -f $INSTALL_DIR/logs/error.log"
    echo -e "  ${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    echo -e "${GREEN}âœ… Panel instalado correctamente.${NC}"
    echo -e "${YELLOW}âš ï¸  Guarda estos datos en un lugar seguro${NC}"
    echo ""
}

# Limpiar archivos temporales
cleanup() {
    print_message "Limpiando archivos temporales..."
    
    rm -rf /tmp/panel-install
    rm -f /tmp/panel.zip
    
    print_success "Limpieza completada"
}

# FunciÃ³n principal
main() {
    print_banner
    check_root
    check_system
    get_config
    install_dependencies
    create_directories
    download_panel
    create_login_file
    create_logout_file
    create_check_session
    create_config_file
    create_htaccess
    create_log_file
    copy_panel_files
    modify_index
    configure_nginx
    configure_firewall
    set_permissions
    create_command
    cleanup
    show_summary
    
    log "InstalaciÃ³n completada exitosamente"
}

# Ejecutar funciÃ³n principal
main
