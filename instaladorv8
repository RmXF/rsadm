#!/bin/bash
# Script de instalación automática del Panel VPS

# Colores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo -e "${GREEN}========================================${NC}"
echo -e "${GREEN}    Instalador del Panel VPS Manager    ${NC}"
echo -e "${GREEN}========================================${NC}"

# Solicitar credenciales del panel
echo -e "${YELLOW}Configuración del acceso al panel:${NC}"
read -p "Usuario del panel: " PANEL_USER
read -sp "Contraseña del panel: " PANEL_PASS
echo ""
read -sp "Confirmar contraseña: " PANEL_PASS_CONFIRM
echo ""

if [ "$PANEL_PASS" != "$PANEL_PASS_CONFIRM" ]; then
    echo -e "${RED}Las contraseñas no coinciden${NC}"
    exit 1
fi

# Actualizar sistema
echo -e "${GREEN}Actualizando sistema...${NC}"
apt update && apt upgrade -y

# Instalar dependencias
echo -e "${GREEN}Instalando dependencias necesarias...${NC}"
apt install -y nginx mysql-server php8.1 php8.1-fpm php8.1-mysql \
    php8.1-xml php8.1-mbstring php8.1-curl php8.1-zip \
    php8.1-bcmath php8.1-gd unzip curl wget git

# Instalar Composer
echo -e "${GREEN}Instalando Composer...${NC}"
curl -sS https://getcomposer.org/installer | php
mv composer.phar /usr/local/bin/composer
chmod +x /usr/local/bin/composer

# Instalar Node.js
echo -e "${GREEN}Instalando Node.js...${NC}"
curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
apt install -y nodejs

# Configurar MySQL
echo -e "${GREEN}Configurando base de datos...${NC}"
DB_PASS=$(openssl rand -base64 32)
mysql -e "CREATE DATABASE panel_vps;"
mysql -e "CREATE USER 'panel_user'@'localhost' IDENTIFIED BY '$DB_PASS';"
mysql -e "GRANT ALL PRIVILEGES ON panel_vps.* TO 'panel_user'@'localhost';"
mysql -e "FLUSH PRIVILEGES;"

# Descargar panel
echo -e "${GREEN}Descargando panel VPS Manager...${NC}"
cd /var/www/
wget -O panel.zip "https://tu-servidor.com/panel-vps.zip"
unzip panel.zip -d panel
cd panel

# Instalar dependencias PHP
echo -e "${GREEN}Instalando dependencias PHP...${NC}"
composer install --no-dev --optimize-autoloader

# Instalar dependencias Node
echo -e "${GREEN}Instalando dependencias Node...${NC}"
npm install
npm run production

# Configurar archivo .env
echo -e "${GREEN}Configurando archivo .env...${NC}"
cp .env.example .env
php artisan key:generate
sed -i "s/DB_PASSWORD=.*/DB_PASSWORD=$DB_PASS/" .env
sed -i "s/DB_DATABASE=.*/DB_DATABASE=panel_vps/" .env

# Ejecutar migraciones
echo -e "${GREEN}Creando tablas en base de datos...${NC}"
php artisan migrate --force

# Crear usuario del panel
echo -e "${GREEN}Creando usuario administrador...${NC}"
php artisan tinker --execute="
DB::table('panel_users')->insert([
    'username' => '$PANEL_USER',
    'password' => Hash::make('$PANEL_PASS'),
    'role' => 'admin',
    'created_at' => now(),
    'updated_at' => now()
]);
"

# Configurar Nginx
echo -e "${GREEN}Configurando Nginx...${NC}"
cat > /etc/nginx/sites-available/panel <<EOF
server {
    listen 80;
    server_name _;
    root /var/www/panel/public;

    add_header X-Frame-Options "SAMEORIGIN";
    add_header X-Content-Type-Options "nosniff";

    index index.php;

    charset utf-8;

    location / {
        try_files \$uri \$uri/ /index.php?\$query_string;
    }

    location = /favicon.ico { access_log off; log_not_found off; }
    location = /robots.txt  { access_log off; log_not_found off; }

    error_page 404 /index.php;

    location ~ \.php$ {
        fastcgi_pass unix:/var/run/php/php8.1-fpm.sock;
        fastcgi_param SCRIPT_FILENAME \$realpath_root\$fastcgi_script_name;
        include fastcgi_params;
    }

    location ~ /\.(?!well-known).* {
        deny all;
    }
}
EOF

ln -s /etc/nginx/sites-available/panel /etc/nginx/sites-enabled/
rm /etc/nginx/sites-enabled/default
systemctl restart nginx

# Configurar permisos
echo -e "${GREEN}Configurando permisos...${NC}"
chown -R www-data:www-data /var/www/panel
chmod -R 755 /var/www/panel/storage
chmod -R 755 /var/www/panel/bootstrap/cache

# Crear comando manager
echo -e "${GREEN}Creando comando manager...${NC}"
cat > /usr/local/bin/panel-manager <<'EOF'
#!/bin/bash

show_menu() {
    clear
    echo "==================================="
    echo "    PANEL VPS MANAGER v1.0"
    echo "==================================="
    echo "1) Crear nuevo usuario"
    echo "2) Listar usuarios (tabla)"
    echo "3) Detener/Iniciar panel"
    echo "4) Editar usuario"
    echo "5) Salir"
    echo "==================================="
    read -p "Seleccione una opción: " option
    
    case $option in
        1) create_user ;;
        2) list_users ;;
        3) toggle_panel ;;
        4) edit_user ;;
        5) exit 0 ;;
        *) echo "Opción inválida"; sleep 2; show_menu ;;
    esac
}

create_user() {
    clear
    echo "=== CREAR NUEVO USUARIO ==="
    read -p "Usuario: " username
    read -sp "Contraseña: " password
    echo ""
    read -p "Días de duración: " days
    
    php /var/www/panel/artisan panel:create-user "$username" "$password" "$days"
    
    read -p "Presione Enter para continuar..."
    show_menu
}

list_users() {
    clear
    echo "=== USUARIOS DEL PANEL ==="
    php /var/www/panel/artisan panel:list-users
    read -p "Presione Enter para continuar..."
    show_menu
}

toggle_panel() {
    clear
    if [ -f /var/www/panel/storage/framework/down ]; then
        php /var/www/panel/artisan up
        echo "Panel iniciado"
    else
        php /var/www/panel/artisan down --retry=60 --secret="maintenance"
        echo "Panel detenido - Acceso: /maintenance"
    fi
    sleep 2
    show_menu
}

edit_user() {
    clear
    echo "=== EDITAR USUARIO ==="
    read -p "ID del usuario: " id
    read -p "Nuevo usuario (dejar vacío para no cambiar): " new_username
    read -sp "Nueva contraseña (dejar vacío para no cambiar): " new_password
    echo ""
    read -p "Nuevos días (dejar vacío para no cambiar): " new_days
    
    php /var/www/panel/artisan panel:edit-user "$id" "$new_username" "$new_password" "$new_days"
    
    read -p "Presione Enter para continuar..."
    show_menu
}

show_menu
EOF

chmod +x /usr/local/bin/panel-manager

# Mostrar información de acceso
clear
echo -e "${GREEN}========================================${NC}"
echo -e "${GREEN}    INSTALACIÓN COMPLETADA EXITOSAMENTE    ${NC}"
echo -e "${GREEN}========================================${NC}"
echo ""
echo -e "${YELLOW}Acceso al Panel Web:${NC}"
echo "URL: http://$(curl -s ifconfig.me)"
echo "Usuario: $PANEL_USER"
echo "Contraseña: $PANEL_PASS"
echo ""
echo -e "${YELLOW}Comando de gestión:${NC}"
echo "panel-manager"
echo ""
echo -e "${YELLOW}Base de datos:${NC}"
echo "Usuario: panel_user"
echo "Contraseña: $DB_PASS"
echo "Base de datos: panel_vps"
echo ""
echo -e "${GREEN}========================================${NC}"
