#!/usr/bin/env bash
set -euo pipefail

# ==============================
# CONFIGURACIÓN GENERAL
# ==============================
DB_NAME="reycodessh"
DB_USER="reyuser"
DB_PASS="reypasswd"

PANEL_DIR="/var/www/paneles/reycodessh"
ZIP_URL="https://raw.githubusercontent.com/RmXF/rsadm/main/reycodessh_v2.zip"
BACKUP_DIR="/root/reycodessh_backups"
SSL_DIR="/etc/ssl/reycodessh"
LOG_FILE="/var/log/reycodessh/reycodessh.log"

mkdir -p "$(dirname "$LOG_FILE")"
touch "$LOG_FILE"

# ==============================
# COLORES
# ==============================
G="\e[92m"
R="\e[91m"
Y="\e[93m"
B="\e[94m"
W="\e[97m"
N="\e[0m"

# ==============================
log() {
    echo -e "[$(date '+%Y-%m-%d %H:%M:%S')] [$1] $2" | tee -a "$LOG_FILE"
}

error() {
    log "ERROR" "$1"
    echo -e "${R}[ERROR] $1${N}"
    exit 1
}

ok() {
    log "OK" "$1"
    echo -e "${G}$1${N}"
}

# ==============================
# GENERAR SSL AUTOFIRMADO
# ==============================
generate_ssl() {
    log "INFO" "Generando certificado SSL autofirmado"

    mkdir -p "$SSL_DIR"

    openssl req -x509 -nodes -days 3650 \
        -newkey rsa:4096 \
        -keyout "$SSL_DIR/reycodessh.key" \
        -out "$SSL_DIR/reycodessh.crt" \
        -subj "/C=AR/ST=Argentina/L=Buenos Aires/O=Reycodessh/OU=IT/CN=$(hostname -I | awk '{print $1}')" \
        || error "Error generando certificado SSL"

    chmod 600 "$SSL_DIR/reycodessh.key"
    ok "Certificado SSL creado"
}

# ==============================
install_panel() {
    log "INFO" "Instalando panel Reycodessh"

    apt update -y
    apt install -y apache2 php php-cli php-mysql php-zip php-curl php-json php-mbstring unzip wget curl mysql-server openssl

    systemctl enable apache2

    # Liberar puertos 80 y 443
    fuser -k 80/tcp || true
    fuser -k 443/tcp || true

    ok "Servicios preparados"

    mkdir -p "$PANEL_DIR"

    log "INFO" "Descargando ZIP..."
    if ! wget -O "$PANEL_DIR/panel.zip" "$ZIP_URL"; then
        error "No se pudo descargar el ZIP desde GitHub"
    fi

    log "INFO" "Descomprimiendo"
    unzip -o "$PANEL_DIR/panel.zip" -d "$PANEL_DIR"
    rm "$PANEL_DIR/panel.zip"

    chown -R www-data:www-data "$PANEL_DIR"
    chmod -R 755 "$PANEL_DIR"

    # BASE DE DATOS
    log "INFO" "Configurando base de datos"
    mysql -e "CREATE DATABASE IF NOT EXISTS ${DB_NAME};"
    mysql -e "CREATE USER IF NOT EXISTS '${DB_USER}'@'localhost' IDENTIFIED BY '${DB_PASS}';"
    mysql -e "GRANT ALL PRIVILEGES ON ${DB_NAME}.* TO '${DB_USER}'@'localhost';"
    mysql -e "FLUSH PRIVILEGES;"

    if [ -f "$PANEL_DIR/database.sql" ]; then
        mysql "$DB_NAME" < "$PANEL_DIR/database.sql"
    fi

    # SSL
    generate_ssl

    # APACHE CONF SOLO HTTPS
    log "INFO" "Configurando Apache solo HTTPS"

    CONF="/etc/apache2/sites-available/reycodessh.conf"
    cat > "$CONF" <<EOF
<VirtualHost *:443>
    DocumentRoot $PANEL_DIR
    SSLEngine on
    SSLCertificateFile $SSL_DIR/reycodessh.crt
    SSLCertificateKeyFile $SSL_DIR/reycodessh.key

    <Directory $PANEL_DIR>
        AllowOverride All
        Require all granted
    </Directory>
</VirtualHost>

# BLOQUEAR HTTP
<VirtualHost *:80>
    RewriteEngine On
    RewriteRule ^(.*)$ https://%{HTTP_HOST}\$1 [R=301,L]
</VirtualHost>
EOF

    a2enmod rewrite ssl
    a2dissite 000-default.conf || true
    a2ensite reycodessh.conf
    systemctl restart apache2

    IP=$(hostname -I | awk '{print $1}')

    ok "Instalación completada"
    echo -e "${Y}➡ Accede al panel en:${N} https://$IP/"
}

# ==============================
update_panel() {
    log "INFO" "Actualizando panel..."

    wget -O "$PANEL_DIR/panel.zip" "$ZIP_URL"
    unzip -o "$PANEL_DIR/panel.zip" -d "$PANEL_DIR"
    rm "$PANEL_DIR/panel.zip"

    chown -R www-data:www-data "$PANEL_DIR"
    systemctl restart apache2

    ok "Panel actualizado correctamente"
}

backup_panel() {
    mkdir -p "$BACKUP_DIR"
    TAR="$BACKUP_DIR/backup_$(date +%F_%H-%M-%S).tar.gz"
    tar -czf "$TAR" "$PANEL_DIR"

    ok "Backup creado: $TAR"
}

restore_backup() {
    echo -e "${B}Backups disponibles:${N}"
    ls -1 "$BACKUP_DIR"
    echo -ne "${W}Archivo a restaurar: ${N}"
    read FILE

    tar -xzf "$BACKUP_DIR/$FILE" -C /

    ok "Restauración completada"
}

uninstall_panel() {
    echo -ne "${R}¿Eliminar TODO? (s/n): ${N}"
    read s
    [[ "$s" != "s" ]] && return

    rm -rf "$PANEL_DIR"
    rm -rf "$SSL_DIR"
    rm -f /etc/apache2/sites-available/reycodessh.conf

    mysql -e "DROP DATABASE IF EXISTS ${DB_NAME};"
    mysql -e "DROP USER IF EXISTS '${DB_USER}'@'localhost';"

    systemctl restart apache2

    ok "Panel eliminado por completo"
}

info_system() {
    echo -e "${B}=== SISTEMA ===${N}"
    echo "IP Pública: $(curl -s ifconfig.me)"
    echo "IP Local: $(hostname -I)"
    echo "RAM:"
    free -h
}

# ==============================
# MENÚ ESTILO 3D
# ==============================
while true; do
    clear
    echo -e "${G}╔══════════════════════════════════════╗${N}"
    echo -e "${G}║        INSTALADOR REYCODESSH         ║${N}"
    echo -e "${G}╚══════════════════════════════════════╝${N}"
    echo ""
    echo -e "${B}1) Instalar Panel${N}"
    echo -e "${B}2) Actualizar Panel${N}"
    echo -e "${B}3) Crear Backup${N}"
    echo -e "${B}4) Restaurar Backup${N}"
    echo -e "${B}5) Desinstalar Panel${N}"
    echo -e "${B}6) Información del Sistema${N}"
    echo -e "${R}0) Salir${N}"
    echo ""
    echo -ne "${W}Selecciona una opción:${N} "
    read opt

    case $opt in
        1) install_panel ;;
        2) update_panel ;;
        3) backup_panel ;;
        4) restore_backup ;;
        5) uninstall_panel ;;
        6) info_system ;;
        0) exit ;;
        *) echo -e "${R}Opción inválida${N}" ;;
    esac

    echo -e "\n${Y}Presiona ENTER para continuar...${N}"
    read
done
