#!/usr/bin/env bash
set -euo pipefail

PANEL_NAME="Reycodessh 2.0"
ZIP_URL="https://github.com/RmXF/rsadm/blob/main/reycodessh_v2.zip"
INSTALL_DIR="/var/www/depaneles"
DB_NAME="reycodessh"
DB_USER="reyuser"
DB_PASS="reypasswd"
NGINX_CONF="/etc/nginx/sites-available/reycodessh"

echo "=========================================="
echo "     INSTALADOR AUTOM√ÅTICO $PANEL_NAME"
echo "=========================================="

echo "[1/8] Actualizando paquetes..."
apt update -y

echo "[2/8] Instalando dependencias..."
apt install -y nginx php php-fpm php-mysql php-zip php-cli unzip wget mysql-server

echo "[3/8] Creando directorio del panel..."
mkdir -p "$INSTALL_DIR"
cd "$INSTALL_DIR"

echo "[4/8] Descargando ZIP del panel..."
wget -O reycodessh.zip "$ZIP_URL"

echo "[5/8] Descomprimiendo..."
unzip -o reycodessh.zip
rm reycodessh.zip

echo "[6/8] Configurando permisos..."
chown -R www-data:www-data "$INSTALL_DIR"
chmod -R 755 "$INSTALL_DIR"

echo "[7/8] Configurando base de datos..."
mysql -e "CREATE DATABASE IF NOT EXISTS $DB_NAME;"
mysql -e "CREATE USER IF NOT EXISTS '$DB_USER'@'localhost' IDENTIFIED BY '$DB_PASS';"
mysql -e "GRANT ALL PRIVILEGES ON $DB_NAME.* TO '$DB_USER'@'localhost';"
mysql -e "FLUSH PRIVILEGES;"

echo "[+] Importando estructura SQL..."
mysql $DB_NAME < "$INSTALL_DIR/database.sql"

echo "[8/8] Configurando Nginx..."
cat > "$NGINX_CONF" <<EOF
server {
    listen 80;
    server_name _;

    root $INSTALL_DIR;
    index index.html index.php;

    location / {
        try_files \$uri \$uri/ /index.php;
    }

    location ~ \.php$ {
        include snippets/fastcgi-php.conf;
        fastcgi_pass unix:/run/php/php-fpm.sock;
    }
}
EOF

ln -sf "$NGINX_CONF" /etc/nginx/sites-enabled/reycodessh
nginx -t
systemctl restart nginx

IP=$(hostname -I | awk '{print $1}')

echo "=========================================="
echo "       INSTALACI√ìN COMPLETADA üéâ"
echo "=========================================="
echo " PANEL INSTALADO EN:"
echo " üëâ http://$IP/"
echo ""
echo " Usuario: admin"
echo " Contrase√±a: admin"
echo "=========================================="
